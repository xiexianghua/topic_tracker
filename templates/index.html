<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>话题追踪RSS系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .interval-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .interval-input-group input {
            width: 100px;
        }
        
        .interval-input-group .unit-selector {
            width: 80px;
        }
        
        .interval-display {
            color: #666;
            font-size: 14px;
            margin-left: 10px;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        .topic-item {
            border-bottom: 1px solid #eee;
            padding: 15px 0;
        }
        
        .topic-item:last-child {
            border-bottom: none;
        }
        
        .topic-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .topic-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        .topic-info {
            color: #666;
            font-size: 14px;
        }
        
        .edit-form {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
            display: none;
        }
        
        .edit-form .form-group {
            margin-bottom: 10px;
        }
        
        .edit-form input,
        .edit-form textarea {
            font-size: 13px;
        }
        
        .button-group {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .rss-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #ff6b00;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .rss-link:hover {
            background-color: #e55a00;
        }
        
        .results {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }
        
        .result-item {
            padding: 12px;
            margin-bottom: 12px;
            background-color: white;
            border-radius: 4px;
            font-size: 14px;
            border: 1px solid #e0e0e0;
        }
        
        .result-item:hover {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .time-note {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>话题追踪RSS系统</h1>
        
        <div class="card">
            <h2>添加新话题</h2>
            <form id="addTopicForm">
                <div class="form-group">
                    <label for="name">话题名称</label>
                    <input type="text" id="name" required>
                </div>
                
                <div class="form-group">
                    <label for="search_query">搜索查询</label>
                    <textarea id="search_query" rows="3" required 
                        placeholder="例如：今天关于马斯克有哪些新闻？"></textarea>
                </div>
                
                <div class="form-group">
                    <label>搜索间隔</label>
                    <div class="interval-input-group">
                        <input type="number" id="search_interval_value" min="1" value="1" required>
                        <select id="search_interval_unit" class="unit-selector">
                            <option value="60">分钟</option>
                            <option value="3600" selected>小时</option>
                            <option value="86400">天</option>
                        </select>
                        <span class="interval-display" id="interval_display">每1小时执行一次</span>
                    </div>
                    <div class="time-note">* 所有时间均为北京时间</div>
                </div>
                
                <button type="submit">添加话题</button>
            </form>
        </div>
        
        <div class="card">
            <h2>话题列表</h2>
            <div id="topicsList"></div>
            
            <div style="margin-top: 20px; padding: 15px; background-color: #f0f0f0; border-radius: 4px;">
                <h3 style="margin-bottom: 10px;">RSS订阅方式</h3>
                <p style="margin-bottom: 10px;">
                    <strong>全部话题订阅：</strong>
                    <a href="/rss" class="rss-link" target="_blank" style="display: inline-block; padding: 5px 15px; margin-left: 10px;">订阅所有话题</a>
                </p>
                <p>
                    <strong>单个话题订阅：</strong>
                    每个话题都有独立的RSS订阅链接，可在话题信息中找到
                </p>
            </div>
        </div>
    </div>
    
    <script>
        // 更新间隔显示
        function updateIntervalDisplay() {
            const value = document.getElementById('search_interval_value').value;
            const unit = document.getElementById('search_interval_unit');
            const unitText = unit.options[unit.selectedIndex].text;
            document.getElementById('interval_display').textContent = `每${value}${unitText}执行一次`;
        }
        
        // 监听间隔输入变化
        document.getElementById('search_interval_value').addEventListener('input', updateIntervalDisplay);
        document.getElementById('search_interval_unit').addEventListener('change', updateIntervalDisplay);
        
        // 格式化时间间隔显示
        function formatInterval(seconds) {
            if (seconds < 60) {
                return `${seconds}秒`;
            } else if (seconds < 3600) {
                return `${Math.round(seconds / 60)}分钟`;
            } else if (seconds < 86400) {
                const hours = seconds / 3600;
                return hours === Math.floor(hours) ? `${hours}小时` : `${hours.toFixed(1)}小时`;
            } else {
                const days = seconds / 86400;
                return days === Math.floor(days) ? `${days}天` : `${days.toFixed(1)}天`;
            }
        }
        
        // 获取间隔的数值部分
        function getIntervalValue(seconds) {
            if (seconds % 86400 === 0) {
                return seconds / 86400;
            } else if (seconds % 3600 === 0) {
                return seconds / 3600;
            } else if (seconds % 60 === 0) {
                return seconds / 60;
            } else {
                return seconds;
            }
        }
        
        // 获取间隔的单位
        function getIntervalUnit(seconds) {
            if (seconds % 86400 === 0) {
                return 86400;
            } else if (seconds % 3600 === 0) {
                return 3600;
            } else if (seconds % 60 === 0) {
                return 60;
            } else {
                return 1;
            }
        }
        
        // 切换编辑表单
        function toggleEditForm(topicId) {
            const editForm = document.getElementById(`edit-form-${topicId}`);
            if (editForm.style.display === 'none' || editForm.style.display === '') {
                editForm.style.display = 'block';
            } else {
                editForm.style.display = 'none';
            }
        }
        
        // 更新话题
        async function updateTopic(event, topicId) {
            event.preventDefault();
            
            const intervalValue = parseInt(document.getElementById(`edit-interval-value-${topicId}`).value);
            const intervalUnit = parseInt(document.getElementById(`edit-interval-unit-${topicId}`).value);
            const intervalSeconds = intervalValue * intervalUnit;
            
            const data = {
                name: document.getElementById(`edit-name-${topicId}`).value,
                search_query: document.getElementById(`edit-query-${topicId}`).value,
                search_interval: intervalSeconds
            };
            
            try {
                const response = await fetch(`/api/topics/${topicId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('话题更新成功');
                    toggleEditForm(topicId);
                    loadTopics();
                } else {
                    alert('更新失败');
                }
            } catch (error) {
                console.error('更新话题失败:', error);
                alert('更新失败');
            }
        }
        
        // 加载话题列表
        async function loadTopics() {
            try {
                const response = await fetch('/api/topics');
                const topics = await response.json();
                
                const topicsList = document.getElementById('topicsList');
                topicsList.innerHTML = '';
                
                topics.forEach(topic => {
                    const topicDiv = document.createElement('div');
                    topicDiv.className = 'topic-item';
                    topicDiv.innerHTML = `
                        <div class="topic-header">
                            <div>
                                <div class="topic-title">${topic.name}</div>
                                <div class="topic-info">
                                    查询: ${topic.search_query}<br>
                                    间隔: ${formatInterval(topic.search_interval)} | 
                                    状态: ${topic.is_active ? '活跃' : '暂停'} |
                                    <a href="/rss/${topic.id}" target="_blank" style="color: #ff6b00;">RSS订阅</a>
                                </div>
                            </div>
                            <div class="button-group">
                                <button onclick="triggerSearch(${topic.id})">立即搜索</button>
                                <button onclick="toggleEditForm(${topic.id})">编辑</button>
                                <button onclick="toggleTopic(${topic.id}, ${!topic.is_active})">
                                    ${topic.is_active ? '暂停' : '启用'}
                                </button>
                                <button class="danger" onclick="deleteTopic(${topic.id})">删除</button>
                            </div>
                        </div>
                        
                        <div id="edit-form-${topic.id}" class="edit-form">
                            <h3 style="margin-bottom: 10px;">编辑话题</h3>
                            <form onsubmit="updateTopic(event, ${topic.id})">
                                <div class="form-group">
                                    <label>话题名称</label>
                                    <input type="text" id="edit-name-${topic.id}" value="${topic.name}" required>
                                </div>
                                <div class="form-group">
                                    <label>搜索查询</label>
                                    <textarea id="edit-query-${topic.id}" rows="3" required>${topic.search_query}</textarea>
                                </div>
                                <div class="form-group">
                                    <label>搜索间隔</label>
                                    <div class="interval-input-group">
                                        <input type="number" id="edit-interval-value-${topic.id}" min="1" value="${getIntervalValue(topic.search_interval)}" required>
                                        <select id="edit-interval-unit-${topic.id}" class="unit-selector">
                                            <option value="60" ${getIntervalUnit(topic.search_interval) === 60 ? 'selected' : ''}>分钟</option>
                                            <option value="3600" ${getIntervalUnit(topic.search_interval) === 3600 ? 'selected' : ''}>小时</option>
                                            <option value="86400" ${getIntervalUnit(topic.search_interval) === 86400 ? 'selected' : ''}>天</option>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <button type="submit">保存</button>
                                    <button type="button" onclick="toggleEditForm(${topic.id})">取消</button>
                                </div>
                            </form>
                        </div>
                        
                        <div id="results-${topic.id}" class="results" style="display:none;"></div>
                        <button onclick="toggleResults(${topic.id})">查看结果</button>
                    `;
                    topicsList.appendChild(topicDiv);
                });
            } catch (error) {
                console.error('加载话题失败:', error);
            }
        }
        
        // 添加话题
        document.getElementById('addTopicForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const intervalValue = parseInt(document.getElementById('search_interval_value').value);
            const intervalUnit = parseInt(document.getElementById('search_interval_unit').value);
            const intervalSeconds = intervalValue * intervalUnit;
            
            const data = {
                name: document.getElementById('name').value,
                search_query: document.getElementById('search_query').value,
                search_interval: intervalSeconds
            };
            
            try {
                const response = await fetch('/api/topics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('话题添加成功');
                    document.getElementById('addTopicForm').reset();
                    document.getElementById('search_interval_value').value = 1;
                    updateIntervalDisplay();
                    loadTopics();
                } else {
                    alert('添加失败');
                }
            } catch (error) {
                console.error('添加话题失败:', error);
                alert('添加失败');
            }
        });
        
        // 触发搜索
        async function triggerSearch(topicId) {
            try {
                const response = await fetch(`/api/trigger/${topicId}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    alert('搜索已触发');
                }
            } catch (error) {
                console.error('触发搜索失败:', error);
            }
        }
        
        // 切换话题状态
        async function toggleTopic(topicId, activate) {
            try {
                const response = await fetch(`/api/topics/${topicId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_active: activate })
                });
                
                if (response.ok) {
                    loadTopics();
                }
            } catch (error) {
                console.error('更新话题失败:', error);
            }
        }
        
        // 删除话题
        async function deleteTopic(topicId) {
            if (!confirm('确定要删除这个话题吗？')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/topics/${topicId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadTopics();
                }
            } catch (error) {
                console.error('删除话题失败:', error);
            }
        }
        
        // 显示/隐藏结果
        async function toggleResults(topicId) {
            const resultsDiv = document.getElementById(`results-${topicId}`);
            
            if (resultsDiv.style.display === 'none') {
                // 加载结果
                try {
                    const response = await fetch(`/api/results/${topicId}`);
                    const results = await response.json();
                    
                    resultsDiv.innerHTML = results.map(result => {
                        // 格式化北京时间
                        const beijingTime = new Date(result.created_at).toLocaleString('zh-CN', {
                            timeZone: 'Asia/Shanghai',
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                        
                        return `
                            <div class="result-item">
                                <small>${beijingTime} (北京时间)</small>
                                ${result.in_rss ? '[RSS]' : ''}<br>
                                <div style="white-space: pre-wrap; margin-top: 8px;">${result.content}</div>
                            </div>
                        `;
                    }).join('');
                    
                    resultsDiv.style.display = 'block';
                } catch (error) {
                    console.error('加载结果失败:', error);
                }
            } else {
                resultsDiv.style.display = 'none';
            }
        }
        
        // 初始加载
        loadTopics();
    </script>
</body>
</html>